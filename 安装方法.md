# Oh-My-Novel 安装方法

完整的 oh-my-novel 插件安装和配置指南。

---

## 目录

1. [系统要求](#系统要求)
2. [安装方法](#安装方法)
3. [安装后配置](#安装后配置)
4. [验证安装](#验证安装)
5. [故障排除](#故障排除)
6. [卸载](#卸载)

---

## 系统要求

在安装 oh-my-novel 之前，请确保您具备以下条件：

### 必需工具

| 工具 | 最低版本 | 安装地址 | 检查命令 |
|------|---------|----------|----------|
| **Bun** | 最新版 | https://bun.sh | `bun --version` |
| **OpenCode** | 1.0.150+ | https://github.com/sst/opencode | `opencode --version` |
| **Node.js** | 18+ | https://nodejs.org | `node --version` |
| **Git** | 任意版本 | https://git-scm.com | `git --version` |
| **ripgrep** | 任意版本 | https://github.com/BurntSushi/ripgrep | `rg --version` |

### 安装命令

```bash
# 安装 Bun (Windows)
powershell -c "irm bun.sh/install.ps1 | iex"

# 安装 OpenCode
bun install -g opencode

# 安装 ripgrep (Windows 通过 Chocolatey)
choco install ripgrep
# 或者从 GitHub releases 下载
```

### 验证系统要求

```bash
# 检查所有必需工具
bun --version
opencode --version
node --version
git --version
rg --version
```

---

## 安装方法

有三种方法可以安装 oh-my-novel：

### 方法 1：全局安装（推荐）

**适用场景：** 希望在多个项目中使用 oh-my-novel 的用户。

```bash
# 全局安装
bun install -g oh-my-novel

# 或者从 GitHub 安装
bunx oh-my-novel@latest install
```

### 方法 2：本地安装

**适用场景：** 特定项目使用或开发需求。

```bash
# 克隆仓库
git clone https://github.com/mxrain/oh-my-novel.git
cd oh-my-novel

# 安装依赖
bun install

# 构建插件
bun run build

# 运行交互式安装程序
bunx oh-my-novel install
```

### 方法 3：直接从 GitHub 安装（无需克隆）

**适用场景：** 快速安装，无需克隆仓库。

```bash
# 直接从 GitHub 运行
bunx github:mxrain/oh-my-novel install
```

---

## 安装向导

交互式安装向导会引导您完成整个设置过程：

```bash
bunx oh-my-novel install
```

### 安装向导步骤

#### 步骤 1：依赖检查

向导会自动检查：
- OpenCode 安装情况
- OpenCode 版本（必须 >= 1.0.150）
- Bun 运行时
- Node.js 版本
- Git 安装情况
- ripgrep 安装情况

```
✓ OpenCode 已检测: 1.0.150
✓ Bun 已检测: 1.0.0
✓ Node.js 已检测: 18.17.0
✓ Git 已检测: 2.42.0
✓ ripgrep 已检测: 14.1.0
```

#### 步骤 2：配置文件创建

向导会创建配置文件：

1. **项目级配置**（最高优先级）：
   - `.opencode/oh-my-novel.jsonc`（推荐，支持注释）
   - `.opencode/oh-my-novel.json`

2. **用户级配置**：
   - `~/.config/opencode/oh-my-novel.jsonc`
   - `~/.config/opencode/oh-my-novel.json`

#### 步骤 3：交互式配置

向导会提示您输入：

```bash
? 小说默认类型: fantasy
? 默认章节长度: 3000
? 启用自动保存: Yes
? 长任务批处理大小: 10
? 最大重试次数: 3
```

#### 步骤 4：OpenCode 集成

向导会将插件添加到 OpenCode 配置中：

```json
{
  "plugin": [
    "oh-my-novel"
  ]
}
```

### 非交互式安装

跳过向导提示：

```bash
# 非交互模式
bunx oh-my-novel install --no-tui

# 跳过依赖检查
bunx oh-my-novel install --skip-deps
```

---

## 安装后配置

### 手动配置

如果您跳过了向导或之后需要自定义设置：

#### 1. 创建配置文件

在项目目录中创建 `.opencode/oh-my-novel.jsonc`：

```jsonc
{
  "$schema": "./oh-my-novel.schema.json",
  // 小说设置
  "novelSettings": {
    "defaultGenre": "fantasy",
    "chapterLength": 3000,
    "autoSave": true
  },
  // 代理配置覆盖
  "agents": {
    "novelist": {
      "model": "anthropic/claude-opus-4-5",
      "temperature": 0.7,
      "permission": {
        "edit": "ask",
        "bash": {
          "git": "allow",
          "rm": "deny"
        }
      }
    },
    "plot-designer": {
      "model": "openai/gpt-5.2",
      "temperature": 0.3
    },
    "character-developer": {
      "model": "openai/gpt-5.2",
      "temperature": 0.4
    },
    "world-builder": {
      "model": "anthropic/claude-opus-4-5",
      "temperature": 0.5
    },
    "editor": {
      "model": "google/gemini-3-pro-preview",
      "temperature": 0.3
    }
  },
  // 长任务运行设置
  "longRunning": {
    "maxRetries": 5,
    "retryDelay": 5000,
    "batchSize": 10,
    "checkpointInterval": 1
  },
  // 后台任务设置
  "background_task": {
    "concurrency": 3,
    "timeout": 300000
  }
}
```

#### 2. 配置 OpenCode

将插件添加到 `~/.config/opencode/opencode.json`：

```json
{
  "plugin": [
    "oh-my-novel"
  ],
  "model": "anthropic/claude-opus-4-5",
  "temperature": 0.7
}
```

#### 3. 目录结构

插件会自动创建以下目录：

```
./novels/                    # 小说项目
./.oh-my-novel-state/        # 生成状态存储
```

### 配置优先级

配置文件按以下顺序加载（从高到低优先级）：

1. `.opencode/oh-my-novel.jsonc`（项目级，支持注释）
2. `.opencode/oh-my-novel.json`（项目级）
3. `~/.config/opencode/oh-my-novel.jsonc`（用户级，支持注释）
4. `~/.config/opencode/oh-my-novel.json`（用户级）

高优先级文件会覆盖低优先级设置。

---

## 验证安装

### 运行健康检查

安装完成后，运行 doctor 命令：

```bash
bunx oh-my-novel doctor
```

### 预期输出

```
=== OpenCode 版本检查 ===
✓ OpenCode 版本: 1.0.150 (需要 >= 1.0.150)

=== 依赖验证 ===
✓ Bun: 1.0.0
✓ Node.js: 18.17.0
✓ Git: 2.42.0
✓ ripgrep: 14.1.0

=== 配置验证 ===
✓ 找到配置文件: .opencode/oh-my-novel.jsonc
✓ 配置有效

=== 目录检查 ===
✓ 小说目录存在: ./novels/
✓ 状态目录存在: ./.oh-my-novel-state/

=== 磁盘空间检查 ===
✓ 可用磁盘空间充足: 50GB 空闲

=== 代理配置验证 ===
✓ 所有代理配置正确
✓ 权限已验证

所有检查通过！✓
```

### 测试基本功能

测试插件是否正常工作：

```bash
# 启动 OpenCode
opencode

# 在 OpenCode 中，测试简单命令：
> 创建一个关于龙的奇幻小说
```

预期响应：
```
Novelist: 正在创建一个关于龙的奇幻小说...
- Plot Designer: 正在创建故事大纲...
- Character Developer: 正在创建主角...
- World Builder: 正在构建魔法系统...
```

---

## 故障排除

### 问题：OpenCode 版本过旧

**错误：** `OpenCode version 1.0.100 is lower than required 1.0.150`

**解决方案：**
```bash
# 更新 OpenCode
bun install -g opencode@latest
```

### 问题：未找到 ripgrep

**错误：** `ripgrep is required but not installed`

**解决方案：**

**Windows:**
```bash
# 使用 Chocolatey
choco install ripgrep

# 或者从 GitHub releases 下载
# https://github.com/BurntSushi/ripgrep/releases
```

**macOS:**
```bash
brew install ripgrep
```

**Linux:**
```bash
# Ubuntu/Debian
sudo apt install ripgrep

# Fedora
sudo dnf install ripgrep

# Arch
sudo pacman -S ripgrep
```

### 问题：创建目录时权限被拒绝

**错误：** `Permission denied: ./novels/`

**解决方案：**
```bash
# 手动创建具有适当权限的目录
mkdir -p novels .oh-my-novel-state
chmod 755 novels .oh-my-novel-state
```

### 问题：配置未加载

**错误：** `Configuration file not found`

**解决方案：**

```bash
# 重新运行安装程序
bunx oh-my-novel install

# 或手动创建配置文件
mkdir -p .opencode
cat > .opencode/oh-my-novel.jsonc << 'EOF'
{
  "$schema": "./oh-my-novel.schema.json",
  "novelSettings": {
    "defaultGenre": "fantasy",
    "chapterLength": 3000,
    "autoSave": true
  }
}
EOF
```

### 问题：OpenCode 无法识别插件

**错误：** `Plugin 'oh-my-novel' not found`

**解决方案：**

1. 检查 OpenCode 配置：
   ```bash
   cat ~/.config/opencode/opencode.json
   ```

2. 确保插件已列出：
   ```json
   {
     "plugin": [
       "oh-my-novel"
     ]
   }
   ```

3. 如果是本地安装，确保已构建：
   ```bash
   cd oh-my-novel
   bun run build
   ```

### 问题：构建失败

**错误：** `Build failed with errors`

**解决方案：**

```bash
# 检查 TypeScript 错误
bun run typecheck

# 安装缺失的依赖
bun install

# 清理并重新构建
bun run clean
bun run build
```

### 问题：代理无响应

**错误：** `Agent 'novelist' not responding`

**解决方案：**

1. 检查代理配置：
   ```bash
   cat .opencode/oh-my-novel.jsonc | grep -A 5 "novelist"
   ```

2. 确保模型在您的 OpenCode 配置中可用
3. 检查 API 凭据和网络连接

### 获取更多帮助

如果您仍然遇到问题：

1. 查看 [GitHub Issues](https://github.com/mxrain/oh-my-novel/issues)
2. 搜索类似问题
3. 创建新问题，包含：
   - 错误消息
   - 重现步骤
   - `bunx oh-my-novel doctor` 的输出
   - 系统信息（操作系统、Bun 版本、Node 版本）

---

## 卸载

### 卸载插件

```bash
# 全局卸载
bun uninstall -g oh-my-novel

# 或从本地目录删除
rm -rf oh-my-novel
```

### 删除配置文件

```bash
# 删除项目级配置
rm -rf .opencode/oh-my-novel.jsonc
rm -rf .opencode/oh-my-novel.json

# 删除用户级配置（可选）
rm -rf ~/.config/opencode/oh-my-novel.jsonc
rm -rf ~/.config/opencode/oh-my-novel.json
```

### 从 OpenCode 配置中删除

编辑 `~/.config/opencode/opencode.json` 并从插件列表中删除 `"oh-my-novel"`：

```json
{
  "plugin": []
}
```

### 删除生成的数据（可选）

```bash
# 删除所有小说和状态
rm -rf novels/
rm -rf .oh-my-novel-state/
```

**警告：** 这将删除您的所有小说和生成状态！

---

## 下一步

成功安装后：

1. 阅读 [用户指南](./USER_GUIDE.md) 了解详细使用说明
2. 查看 [AGENTS.md](./AGENTS.md) 了解代理文档
3. 查阅 [QUICK_REFERENCE.md](./QUICK_REFERENCE.md) 快速参考
4. 开始写您的第一部小说！

---

## 支持

- **GitHub 仓库：** https://github.com/mxrain/oh-my-novel
- **问题报告：** https://github.com/mxrain/oh-my-novel/issues
- **讨论区：** https://github.com/mxrain/oh-my-novel/discussions
- **文档：** [README.md](./README.md)

---

**最后更新：** 2026年1月18日
